apiVersion: 1

groups:
  - orgId: 1
    name: "Spring alerts"
    folder: "Alerts"
    interval: 30s
    rules:

      - uid: spring-target-missing
        title: "Spring Target Missing"
        condition: C
        for: 2m
        noDataState: OK
        execErrState: Alerting
        annotations:
          summary: "Spring metrics missing"
          description: "No up{job=\"spring\"} targets for ~2 minutes."
        labels:
          severity: critical
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange: { from: 300, to: 0 }
            model:
              expr: count(up{job="spring"})
              instant: true
          - refId: B
            datasourceUid: __expr__
            model: { type: reduce, expression: A, reducer: last }
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - type: query
                  reducer: { type: last }
                  operator: { type: and }
                  evaluator: { type: lt, params: [ 1 ] }

      - uid: spring-app-down
        title: "Spring App Down"
        condition: C
        for: 1m
        noDataState: Alerting
        execErrState: Alerting
        annotations:
          summary: "Spring is DOWN"
          description: "up{job=\"spring\"} < 1 for 1m."
        labels:
          severity: critical
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange: { from: 300, to: 0 }
            model:
              expr: max_over_time(up{job="spring"}[2m])
              instant: true
          - refId: B
            datasourceUid: __expr__
            model: { type: reduce, expression: A, reducer: last }
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - type: query
                  reducer: { type: last }
                  operator: { type: and }
                  evaluator: { type: lt, params: [1] }

      - uid: spring-5xx-high
        title: "High 5xx rate (Spring)"
        condition: C
        for: 5m
        noDataState: OK
        execErrState: Alerting
        annotations:
          summary: "High 5xx rate"
          description: "5xx > 5% for 5m."
        labels:
          severity: critical
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange: { from: 600, to: 0 }
            model:
              expr: |
                (
                  sum(rate(http_server_requests_seconds_count{job="spring",status=~"5.."}[5m]))
                /
                  sum(rate(http_server_requests_seconds_count{job="spring"}[5m]))
                ) * 100
              instant: true
          - refId: B
            datasourceUid: __expr__
            model: { type: reduce, expression: A, reducer: last }
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - type: query
                  reducer: { type: last }
                  operator: { type: and }
                  evaluator: { type: gt, params: [5] }

      - uid: spring-latency-p95
        title: "High latency p95 (Spring)"
        condition: C
        for: 10m
        noDataState: OK
        execErrState: Alerting
        annotations:
          summary: "High latency"
          description: "p95 > 1s for 10m."
        labels:
          severity: warning
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange: { from: 900, to: 0 }
            model:
              expr: |
                histogram_quantile(0.95,
                  sum by (le) (rate(http_server_requests_seconds_bucket{job="spring"}[5m]))
                )
              instant: true
          - refId: B
            datasourceUid: __expr__
            model: { type: reduce, expression: A, reducer: last }
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - type: query
                  reducer: { type: last }
                  operator: { type: and }
                  evaluator: { type: gt, params: [1] }

      - uid: spring-jvm-heap-high
        title: "JVM Heap High (Spring)"
        condition: C
        for: 10m
        noDataState: OK
        execErrState: Alerting
        annotations:
          summary: "JVM heap high"
          description: "Heap used > 85% for 10m."
        labels:
          severity: warning
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange: { from: 900, to: 0 }
            model:
              expr: |
                (
                  sum(jvm_memory_used_bytes{job="spring",area="heap"})
                /
                  sum(jvm_memory_max_bytes{job="spring",area="heap"})
                ) * 100
              instant: true
          - refId: B
            datasourceUid: __expr__
            model: { type: reduce, expression: A, reducer: last }
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - type: query
                  reducer: { type: last }
                  operator: { type: and }
                  evaluator: { type: gt, params: [85] }